FROM centos:centos7.4.1708
MAINTAINER Felipe Macias <felipe.macias@freetechsolutions.com.ar>

ENV build-date 2018
ENV kamailio_location /opt/omnileads/kamailio

#Exclude postgres of list of update
COPY extra-files/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo


RUN yum update -y
RUN yum -y install gcc gcc-c++ bison bison-devel flex make expat expat-devel net-snmp-devel  libxml2 libxml2-devel openssl-devel \
    xmlrpc-c-devel lynx pcre pcre-devel ncurses-devel ncurses-libs gdb git net-snmp net-snmp-devel net-snmp-libs net-snmp-utils \
    libtool-ltdl-devel iptables-devel iptables-services xmlrpc-c-devel libpcap-devel glib2-devel json-glib-devel hiredis-devel \
    libevent* redis hiredis json-* python-devel libuuid libuuid-devel  libunistring-devel libxml which

#Install the kernel headers and devel running in base OS
RUN yum remove kernel-headers kernel-devel kernel-tools-libs kernel-tools-libs-devel -y
RUN yum install kernel-$(uname -r) kernel-headers-$(uname -r) kernel-devel-$(uname -r) kernel-tools-libs-$(uname -r) kernel-tools-libs-devel-$(uname -r) -y
RUN yum install gcc gcc-c++ epel-release wget -y

#Install postgres-9.6 libraries and headers
RUN yum install -y https://download.postgresql.org/pub/repos/yum/9.6/redhat/rhel-7-x86_64/pgdg-redhat96-9.6-3.noarch.rpm
RUN yum install postgresql96-devel -y


#Change of systemctl to make it work with Docker
COPY systemctl.py /usr/bin/systemctl.py
RUN cp -f /usr/bin/systemctl /usr/bin/systemctl.original \
    && chmod +x /usr/bin/systemctl.py \
    && cp -f /usr/bin/systemctl.py /usr/bin/systemctl

#Install of ffmpeg repository
RUN rpm --import http://li.nux.ro/download/nux/RPM-GPG-KEY-nux.ro && rpm -Uvh http://li.nux.ro/download/nux/dextop/el7/x86_64/nux-dextop-release-0-5.el7.nux.noarch.rpm
RUN yum install ffmpeg ffmpeg -y

#Installation and configuration of rtpengine
WORKDIR /usr/src/
RUN wget https://github.com/sipwise/rtpengine/archive/mr5.5.3.1.tar.gz
RUN tar xzvf mr5.5.3.1.tar.gz && mv rtpengine-* rtpengine
RUN yum install hiredis hiredis-devel -y
WORKDIR /usr/src/rtpengine/daemon/
RUN make && \
    cp -u rtpengine /usr/local/bin/
WORKDIR /usr/src/rtpengine/iptables-extension/
RUN make && \
    cp -u libxt_RTPENGINE.so /lib64/xtables
    #if [ ! -d "/usr/src/kernels/$(uname -r)" ]; then \
#	echo "Could Not Find the Kernel Headers For The current Kernel.\n"; \
#	exit 0 ; \
 #   fi && \
WORKDIR /usr/src/rtpengine/kernel-module/
RUN sed -i 's/\(^KSRC\).*/\KSRC   ?= \/usr\/src\/kernels\/$(shell uname -r)/' Makefile && \
    make
#    insmod xt_RTPENGINE.ko
RUN ls /lib/ && find / -name extra
RUN cp -u xt_RTPENGINE.ko "/lib/modules/$(uname -r)/extra/"
#RUN depmod -e -F /usr/src/kernels/-$(uname -r)/System.map
RUN depmod -a
COPY kamailio-files/rtpengine_sysconfig /etc/sysconfig/rtpengine
COPY kamailio-files/rtpengine.service /etc/systemd/system
COPY kamailio-files/rsyslog.conf /etc/rsyslog.conf
RUN mkdir /var/log/rtpengine && mkdir /var/log/kamailio
RUN touch /var/log/rtpengine/rtpengine.log && touch /var/log/rtpengine/kamailio.log
WORKDIR /usr/src
RUN rm -rf /usr/src/kamailio /usr/src/rtpengine

#Installation and configuration of Kamailio
WORKDIR /usr/src
RUN git clone --depth 1 --no-single-branch git://git.kamailio.org/kamailio kamailio
WORKDIR /usr/src/kamailio
RUN git checkout -b 4.4 origin/4.4 && make PREFIX=$kamailio_location cfg
RUN sed -i "10s/.*/include_modules= presence presence_xml app_python auth_ephemeral db_postgres ndb_redis presence tls uuid websocket/" /usr/src/kamailio/modules.lst
COPY kamailio-files/Makefile /usr/src/kamailio/modules/db_postgres/
RUN make all && make install

#Copy of init scripts and link of binaries
COPY kamailio-files/kamailio.service /etc/systemd/system/
COPY kamailio-files/kamailio /etc/default/
RUN ln -s $kamailio_location/sbin/kamctl /usr/sbin/
RUN ln -s $kamailio_location/sbin/kamcmd /usr/sbin/

#Creation of omnileads user
RUN useradd omnileads
RUN yum install openssl -y
# Make ports available to the world outside this container
EXPOSE 14443 5432 5060 5061 6060 6061 1080 10000-20000/udp

CMD ["/usr/sbin/init"]
